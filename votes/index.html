<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="icon" type="image/x-icon" href="/public/favicon.ico">
        <title>CoM - Votes</title>

        <link rel="stylesheet" href="/public/style.css">
        <link rel="stylesheet" href="style.css">

        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=National+Park:wght@200..800&display=swap" rel="stylesheet">

        <script src="/public/tokenRequired.js"></script>
        <script src="/public/footer.js"></script>
    </head>
    <body>
        <script>
            requireTokenOrRedirect();
        </script>

        <div class="layout-container">
            <div class="sidebar regular-glassmorphism">
                <div class="sidebar__campfire" onclick="window.location.pathname = '/campfire/'">
                    <svg width="32" height="32" viewBox="0 0 97 122" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M88.7619 78.9755C90.2137 78.4562 91.8092 78.5116 93.2215 79.1304C94.6338 79.7492 95.756 80.8846 96.3584 82.304C96.9607 83.7234 96.9976 85.3193 96.4614 86.765C95.9252 88.2107 94.8566 89.3967 93.4744 90.0801L92.8219 90.358L66.4621 99.7709L92.8219 109.184C94.2807 109.696 95.4875 110.749 96.1937 112.124C96.9 113.5 97.052 115.094 96.6184 116.578C96.1848 118.062 95.1987 119.324 93.8631 120.103C92.5274 120.882 90.9439 121.119 89.4386 120.766L88.7619 120.566L48.5002 106.187L8.23856 120.566C6.78673 121.086 5.19128 121.03 3.77899 120.411C2.3667 119.793 1.24445 118.657 0.642093 117.238C0.03974 115.818 0.00287299 114.222 0.539044 112.777C1.07521 111.331 2.14385 110.145 3.52606 109.462L4.17856 109.184L30.5384 99.7709L4.17856 90.358C2.71974 89.8454 1.51297 88.793 0.806713 87.4175C0.100453 86.042 -0.0515371 84.448 0.382035 82.9638C0.815607 81.4796 1.80174 80.2181 3.13739 79.4391C4.47305 78.6601 6.05656 78.4228 7.56189 78.7761L8.23856 78.9755L48.5002 93.3546L88.7619 78.9755ZM43.8481 5.47257L48.1196 2.6934L49.4488 1.88986C52.4092 0.216319 55.6717 -0.889307 58.4931 1.56361C60.1848 3.02569 60.7467 5.0859 60.4446 7.18236L60.2029 8.4209L60.1123 9.26674C60.0821 9.77424 60.0821 10.4086 60.1606 11.1215C60.6802 15.7797 63.8521 19.1086 67.1388 22.1234L69.8998 24.6367L71.9661 26.5882C76.8719 31.3732 82.2852 37.8257 84.5629 46.9486C87.3059 57.9082 84.5992 67.738 77.4217 74.6617C70.4979 81.3559 60.1063 84.6667 48.5002 84.6667C29.3542 84.6667 12.2502 72.2692 12.2502 51.4376C12.2502 35.1492 23.0165 22.2865 32.4415 14.0397C36.0567 10.9379 39.8712 8.07609 43.8602 5.47257M49.8415 43.9701L48.5002 42.3751L47.165 43.9701L45.7331 45.7886L44.6033 47.3111L43.395 49.0269C40.0963 53.8542 36.4169 60.4819 36.4169 66.0403C36.4169 72.9882 41.8302 78.6251 48.5002 78.6251C55.1763 78.6251 60.5836 72.9882 60.5836 66.0403C60.5836 60.4819 56.9042 53.8542 53.6054 49.0269L52.3971 47.3111L51.2673 45.7886L49.8415 43.9701Z" fill="#4A2D24"></path>
                    </svg>
                </div>
                <div class="sidebar__explore" onclick="window.location.pathname = '/explore/'">  
                    <svg width="32" height="32" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M20 0C31.046 0 40 8.954 40 20C40 31.046 31.046 40 20 40C8.954 40 0 31.046 0 20C0 8.954 8.954 0 20 0ZM28.486 11.514C27.778 10.808 18.586 12.928 15.758 15.758C12.93 18.586 10.808 27.778 11.514 28.486C12.222 29.192 21.414 27.072 24.242 24.242C27.072 21.414 29.192 12.222 28.486 11.514ZM20 18C20.5304 18 21.0391 18.2107 21.4142 18.5858C21.7893 18.9609 22 19.4696 22 20C22 20.5304 21.7893 21.0391 21.4142 21.4142C21.0391 21.7893 20.5304 22 20 22C19.4696 22 18.9609 21.7893 18.5858 21.4142C18.2107 21.0391 18 20.5304 18 20C18 19.4696 18.2107 18.9609 18.5858 18.5858C18.9609 18.2107 19.4696 18 20 18Z" fill="#4A2D24"></path>
                    </svg>
                </div>
                <div class="sidebar__shop" onclick="window.location.pathname = '/shop/'">
                    <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M11.625 28.5C12.056 28.5 12.4693 28.6712 12.774 28.976C13.0788 29.2807 13.25 29.694 13.25 30.125C13.25 30.556 13.0788 30.9693 12.774 31.2741C12.4693 31.5788 12.056 31.75 11.625 31.75C11.194 31.75 10.7807 31.5788 10.476 31.2741C10.1712 30.9693 10 30.556 10 30.125C10 29.694 10.1712 29.2807 10.476 28.976C10.7807 28.6712 11.194 28.5 11.625 28.5ZM23 28.5C23.431 28.5 23.8443 28.6712 24.149 28.976C24.4538 29.2807 24.625 29.694 24.625 30.125C24.625 30.556 24.4538 30.9693 24.149 31.2741C23.8443 31.5788 23.431 31.75 23 31.75C22.569 31.75 22.1557 31.5788 21.851 31.2741C21.5462 30.9693 21.375 30.556 21.375 30.125C21.375 29.694 21.5462 29.2807 21.851 28.976C22.1557 28.6712 22.569 28.5 23 28.5ZM0.574999 0.712504C0.812396 0.395913 1.15716 0.176824 1.5446 0.0963443C1.93204 0.0158644 2.33553 0.0795238 2.67937 0.275378L2.85 0.389128L5.6255 2.46913C6.09783 2.82353 6.46467 3.29992 6.68662 3.84713L6.78412 4.125H27.6589C28.0994 4.12489 28.5354 4.21435 28.9403 4.38794C29.3452 4.56153 29.7106 4.81563 30.0143 5.1348C30.3179 5.45397 30.5535 5.83154 30.7068 6.24458C30.86 6.65762 30.9277 7.09751 30.9056 7.5375L30.8845 7.778L30.1419 13.7174C29.919 15.5048 29.1085 17.1674 27.8378 18.444C26.5671 19.7206 24.9082 20.5388 23.1219 20.7699L22.7546 20.8073L10.871 21.7985L11.2935 23.625H25.4375C25.8517 23.6255 26.25 23.7841 26.5512 24.0684C26.8524 24.3527 27.0336 24.7413 27.0579 25.1548C27.0822 25.5682 26.9477 25.9754 26.6818 26.293C26.416 26.6106 26.0389 26.8147 25.6276 26.8636L25.4375 26.875H11.2935C10.6039 26.8751 9.93205 26.6559 9.37526 26.2489C8.81847 25.842 8.40556 25.2685 8.19625 24.6114L8.12637 24.3563L3.67387 5.0675L0.899999 2.9875C0.555218 2.72892 0.32728 2.34396 0.266331 1.91731C0.205382 1.49067 0.316413 1.05729 0.574999 0.712504Z" fill="#4A2D24"></path>
                    </svg>
                </div>
                <div class="sidebar__votes" onclick="window.location.pathname = '/votes'">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 39 35" fill="none" class="w-8 mr-4 h-8">
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M19.5 0.625C19.9973 0.625 20.4742 0.822544 20.8258 1.17417C21.1775 1.52581 21.375 2.00272 21.375 2.5V4.375H22.8075C23.3894 4.37504 23.9633 4.51049 24.4837 4.77063L27.4425 6.25H34.5C34.9973 6.25 35.4742 6.44754 35.8258 6.79918C36.1775 7.15081 36.375 7.62772 36.375 8.125C36.375 8.62228 36.1775 9.09919 35.8258 9.45082C35.4742 9.80246 34.9973 10 34.5 10H33.7837L38.0512 18.5369C38.1825 18.7975 38.25 19.0844 38.25 19.375C38.25 21.3641 37.4598 23.2718 36.0533 24.6783C34.6468 26.0848 32.7391 26.875 30.75 26.875C28.7609 26.875 26.8532 26.0848 25.4467 24.6783C24.0402 23.2718 23.25 21.3641 23.25 19.375C23.25 19.0844 23.3175 18.7975 23.4487 18.5369L27.7162 10H27.4425C26.8606 9.99996 26.2867 9.86451 25.7663 9.60437L22.8075 8.125H21.375V30.625H27C27.4973 30.625 27.9742 30.8225 28.3258 31.1742C28.6775 31.5258 28.875 32.0027 28.875 32.5C28.875 32.9973 28.6775 33.4742 28.3258 33.8258C27.9742 34.1775 27.4973 34.375 27 34.375H12C11.5027 34.375 11.0258 34.1775 10.6742 33.8258C10.3225 33.4742 10.125 32.9973 10.125 32.5C10.125 32.0027 10.3225 31.5258 10.6742 31.1742C11.0258 30.8225 11.5027 30.625 12 30.625H17.625V8.125H16.1925L13.2338 9.60437C12.7133 9.86451 12.1394 9.99996 11.5575 10H11.2838L15.5513 18.5369C15.6816 18.797 15.7497 19.084 15.75 19.375C15.75 21.3641 14.9598 23.2718 13.5533 24.6783C12.1468 26.0848 10.2391 26.875 8.25 26.875C6.26088 26.875 4.35322 26.0848 2.9467 24.6783C1.54018 23.2718 0.75 21.3641 0.75 19.375C0.750311 19.084 0.818356 18.797 0.94875 18.5369L5.21625 10H4.5C4.00272 10 3.52581 9.80246 3.17417 9.45082C2.82254 9.09919 2.625 8.62228 2.625 8.125C2.625 7.62772 2.82254 7.15081 3.17417 6.79918C3.52581 6.44754 4.00272 6.25 4.5 6.25H11.5575L14.5162 4.77063C15.0367 4.51049 15.6106 4.37504 16.1925 4.375H17.625V2.5C17.625 2.00272 17.8225 1.52581 18.1742 1.17417C18.5258 0.822544 19.0027 0.625 19.5 0.625Z" fill="#4A2D24"></path>
                    </svg>
                </div>
            </div>
            <div class="main-area regular-glassmorphism">
                <div id="main-area__section" class="main-area__section">
                    <div class="under-construction__div regular-glassmorphism">
                        <h2>Loading Projects...</h2>
                        <p>Please wait while we fetch the latest voting projects.</p>
                    </div>
                </div>
            </div>
        </div>

        <script type="module">
            import initEpoxy, {EpoxyClient, EpoxyClientOptions} from '../public/pkg/epoxy-bundled.js';

            let epoxyClient;

            async function getEpoxyClient() {
                if (!epoxyClient) {
                    await initEpoxy();
                    const options = new EpoxyClientOptions();
                    options.user_agent = navigator.userAgent;
                    options.wisp_v2 = true;
                    epoxyClient = new EpoxyClient('wss://wisp.mercurywork.shop', options);
                }
                return epoxyClient;
            }

            async function fetchVotes(cookie) {
                const client = await getEpoxyClient();
                const response = await client.fetch('https://summer.hackclub.com/votes/new', {
                    headers: {
                        Cookie: cookie,
                        'User-Agent': navigator.userAgent,
                        Accept: 'text/html',
                    },
                });
                return response.text();
            }

            function parseVotingPageData(html) {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');

                const votingData = {
                    projects: [],
                    voteForm: {},
                    voteCount: {
                        needed: 0,
                        globalSubmitted: 0,
                    },
                };

                const voteForm = doc.querySelector('form[action="/votes"]');
                if (voteForm) {
                    votingData.voteForm.action = voteForm.action;
                    votingData.voteForm.method = voteForm.method;
                    votingData.voteForm.authenticityToken = voteForm.querySelector(
                        'input[name="authenticity_token"]',
                    )?.value;
                    votingData.voteForm.signature = voteForm.querySelector(
                        'input[name="vote[signature]"]',
                    )?.value;
                    votingData.voteForm.shipEvent1Id = voteForm.querySelector(
                        'input[name="vote[ship_event_1_id]"]',
                    )?.value;
                    votingData.voteForm.shipEvent2Id = voteForm.querySelector(
                        'input[name="vote[ship_event_2_id]"]',
                    )?.value;
                } else {
                    console.warn('Voting form not found in parsed HTML.')
                    return votingData;
                }

                const voteCountParagraphs = doc.querySelectorAll(
                    '.md\\:mt-\\[53\\].mt-4 + p, .text-lg.md\\:text-xl.opacity-60, .text-center.text-nice-blue.text-lg.mb-6',
                );

                const neededVotesParagraph = Array.from(voteCountParagraphs).find(p =>
                    p.textContent.includes('You need to vote'),
                );
                if (neededVotesParagraph) {
                    const match = neededVotesParagraph.textContent.match(/vote (\d+) more times!/);
                    if (match) {
                        votingData.voteCount.needed = parseInt(match[1]);
                    }
                }

                const submittedVotesParagraph = Array.from(voteCountParagraphs).find(p =>
                    p.textContent.includes('votes have been submitted so far!'),
                );
                if (submittedVotesParagraph) {
                    const match = submittedVotesParagraph.textContent.match(
                        /(\d+) votes have been submitted so far!/,
                    );
                    if (match) {
                        votingData.voteCount.globalSubmitted = parseInt(match[1]);
                    }
                }

                doc
                    .querySelectorAll('.grid.grid-cols-1.lg\\:grid-cols-2 > div[data-project-index]')
                    .forEach((projectDiv, index) => {
                        const project = {};
                        const projectIdElement = projectDiv.querySelector('input[type="radio"]');
                        project.id = 
                            index === 0
                                ? votingData.voteForm.shipEvent1Id
                                : votingData.voteForm.shipEvent2Id;

                        project.banner = projectDiv.querySelector('div.rounded-lg img')?.src;
                        project.title = projectDiv.querySelector('h3')?.textContent.trim();
                        project.devlogs = projectDiv
                            .querySelector('.flex-wrap.items-center span:first-child')
                            ?.textContent.trim();
                        project.timeSpent = projectDiv
                            .querySelector('.flex-wrap.items-center span:nth-child(4)')
                            ?.textContent.trim();
                        
                        project.description = projectDiv
                            .querySelector('[data-devlog-card-target="content"]')
                            ?.textContent.trim();
                        
                        project.demoLink = projectDiv.querySelector('a[data-analytics-link="demo"]')?.href;
                        project.repoLink = projectDiv.querySelector('a[data-analytics-link="repo"]')?.href;

                        project.devlogEntries = [];
                        projectDiv
                            .querySelectorAll('.space-y-4.sm\\:space-y-8 > .card-with-gradient')
                            .forEach(devlogCard => {
                                const devlog = {};
                                devlog.author = devlogCard
                                    .querySelector('.flex.items-center > div > span:not(.text-\\[\\#B89576\\])')
                                    ?.textContent.trim();
                                devlog.timeSpent = devlogCard
                                    .querySelector('.text-\\[\\#B89576\\] span:first-child')
                                    ?.textContent.trim();
                                devlog.timeAgo = devlogCard
                                    .querySelector('.text-\\[\\#B89576\\] span:nth-child(3)')
                                    ?.textContent.trim();
                                devlog.content = devlogCard
                                    .querySelector('[data-devlog-card-target="content"]')
                                    ?.innerHTML;
                                devlog.attachment = devlogCard.querySelector('div.sm\\:mt-3 img')?.src;
                                project.devlogEntries.push(devlog);
                            });
                        votingData.projects.push(project);
                    });

                return votingData;
            };

            let votes = [];

            function showSkeleton() {
                document.getElementById('approved__display').textContent = '';
                document.getElementById('certified__display').textContent = '';
                document.getElementById('approved__display').classList.add('skeleton', 'skeleton-title');
                document.getElementById('certified__display').classList.add('skeleton', 'skeleton-line');
            }

            async function loadPage() {
                const mainAreaSection = document.getElementById('main-area__section');
                mainAreaSection.innerHTML = `
                    <div class="under-contruction__div regular-glassmorphism">
                        <h2>Loading Projects...</h2>
                        <p>Please wait while we fetch the latest voting projects.</p>
                    </div>
                `;
                const cookie = getToken();
                const votePath = '/votes/new';

                try {
                    const client = await getEpoxyClient();
                    const response = await client.fetch(`https://summer.hackclub.com${votePath}`, {
                        headers: {
                            Cookie: cookie,
                            'User-Agent': navigator.userAgent,
                            Accept: 'text/html',
                        },
                    });
                    const html = await response.text();
                    const votingPageData = parseVotingPageData(html);

                    renderVotingPage(votingPageData);
                } catch (err) {
                    console.error('Failed to load voting data:', err);
                    mainAreaSection.innerHTML = `
                        <div class="under-construction__div regular-glassmorphism">
                            <h2>Error Loading Projects!</h2>
                            <p>Failed to load voting projects. Please check your internet connection or try again later. (Error: ${err.message})</p>
                        </div>
                    `;
                }
            }

            // async function fetchPage() {
            //     showSkeleton();

            //     const cookie = getToken();
            //     const votePath = "/votes/locked";

            //     try {
            //         const voteRes = await fetch('/fetch', {
            //             method: 'POST',
            //             headers: {'Content-Type': 'application/json'},
            //             body: JSON.stringify({cookie, path: votePath})
            //         });

            //         const voteText = await voteRes.text();
            //         console.log("Raw voteText:", voteText);
            //         let voteData;
            //         try {
            //             const parsed = JSON.parse(voteText);
            //             voteData = parsed?.extractedData;
            //         } catch (e) {
            //             throw new Error("Invalid JSON rsponse from backend (/votes)")
            //         }

            //         votes = voteData.votes || [];

            //         document.getElementById('approved__display').classList.remove('skeleton', 'skeleton-title');
            //         document.getElementById('certified__display').classList.remove('skeleton', 'skeleton-line');

            //         renderVotes();
            //     } catch (err) {
            //         alert(err.message);
            //     }
            // }

            function renderVotingPage(data) {
                const mainAreaSection = document.getElementById('main-area__section');
                mainAreaSection.innerHTML = '';

                if (!data.projects || data.projects.length < 2 || !data.voteForm.authenticityToken) {
                    mainAreaSection.innerHTML = `
                        <div class="under-construction__div regular-glassmorphism">
                            <h2>oops :c</h2>
                            <p>no project r available for voting rn >:(</p>
                        </div>
                    `;
                    return;
                }

                let projectsHtml = '';
                data.projects.forEach((project, index) => {
                    projectsHtml += `
                        <div class="project-card custom-card-base" data-project-index="${index}">
                            <div class="project-card-header">
                                <div class="project-thumbnail">
                                    <img alt="${project.title}" loading="lazy" src="${project.banner}"/>
                                </div>
                                <div class="project-info">
                                    <h3 class="project-title">${project.title}</h3>
                                    <div class="project-meta">
                                        <span>${project.devlogs} devlogs</span>
                                        <span>‚Ä¢</span>
                                        <span>${project.timeSpent}</span>
                                    </div>
                                    <div class="project-description">
                                        <div>${project.description}</div>
                                    </div>
                                </div>
                            </div>

                            <div class="action-buttons-group">
                                ${project.demoLink ? `<a href="${project.demoLink}" target="_blank" class="action-button action-button-demo">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="icon-small"><g fill="none" fill-rule="evenodd"><path d="M24 0v24H0V0zM12.593 23.258l-.011.002-.071.035-.02.004-.014-.004-.071-.035c-.01-.004-.019-.001-.024.005l-.004.01-.017.428.005.02.01.013.104.074.015.004.012-.004.104-.074.012-.016.004-.017-.017-.427c-.002-.01-.009-.017-.017-.018m.265-.113-.013.002-.185.093-.01.01-.003.011.018.43.005.012.008.007.201.093c.012.004.023 0 .029-.008l.004-.014-.034-.614c-.003-.012-.01-.02-.02-.022m-.715.002a.023.023 0 0 0-.027.006l-.006.014-.034.614c0 .012.007.02.017.024l.015-.002.201-.093.01-.008.004-.011.017-.43-.003-.012-.01-.01z"></path><path fill="#09244BFF" fill-rule="nonzero" d="M12 2c5.523 0 10 4.477 10 10s-4.477 10-10 10S2 17.523 2 12 6.477 2 12 2m2 11.4-1.564 1.251a.5.5 0 0 0-.041.744l1.239 1.239a2 2 0 0 1 .508.864l.175.613a1.8 1.8 0 0 0 1.017 1.163 8.021 8.021 0 0 0 2.533-1.835l-.234-1.877a2 2 0 0 0-1.09-1.54l-1.47-.736A1 1 0 0 0 14 13.4M12 4a7.987 7.987 0 0 0-6.335 3.114l-.165.221V9.02a3 3 0 0 0 1.945 2.809l.178.06 1.29.395c1.373.42 2.71-.697 2.577-2.096l-.019-.145-.175-1.049a1 1 0 0 1 .656-1.108l.108-.03.612-.14a2.667 2.667 0 0 0 1.989-3.263A7.987 7.987 0 0 0 12 4"></path></g></svg>
                                    Demo
                                </a>` : ''}
                                ${project.repoLink ? `<a href="${project.repoLink}" target="_blank" class="action-button action-button-repo">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="icon-small"><g fill="none"><path d="M24 0v24H0V0zM12.593 23.258l-.011.002-.071.035-.02.004-.014-.004-.071-.035c-.01-.004-.019-.001-.024.005l-.004.01-.017.428.005.02.01.013.104.074.015.004.012-.004.104-.074.012-.016.004-.017-.017-.427c-.002-.01-.009-.017-.017-.018m.265-.113-.013.002-.185.093-.01.01-.003.011.018.43.005.012.008.007.201.093c.012.004.023 0 .029-.008l.004-.014-.034-.614c-.003-.012-.01-.02-.02-.022m-.715.002a.023.023 0 0 0-.027.006l-.006.014-.034.614c0 .012.007.02.017.024l.015-.002.201-.093.01-.008.004-.011.017-.43-.003-.012-.01-.01z"></path><path fill="#09244BFF" d="M3 6a3 3 0 1 1 4 2.83v2.705A3.982 3.982 0 0 1 9 11h6a2 2 0 0 0 2-2v-.17a3.001 3.001 0 1 1 2 0V9a4 4 0 0 1-4 4H9a2 2 0 0 0-2 2v.17a3.001 3.001 0 1 1-2 0V8.83A3.001 3.001 0 0 1 3 6"></path></g></svg>
                                    Repository
                                </a>` : ''}
                                <button class="action-button action-button-report" disabled>üö© Report Fraud</button>
                            </div>

                            <div class="devlog-list">
                                ${project.devlogEntries
                                .map(
                                    devlog => `
                                    <div class="devlog-card custom-card-base">
                                        <div class="devlog-header">
                                            <img src="${
                                            devlog.authorAvatar ||
                                            'https://secure.gravatar.com/avatar/4dea9b8b278b9ecd6a9d5384faad1653.jpg?s=192&d=https%3A%2F%2Fa.slack-edge.com%2Fdf10d%2Fimg%2Favatars%2Fava_0014-192.png'
                                            }" alt="${
                                            devlog.author
                                            }" class="devlog-avatar" loading="lazy">
                                            <div>
                                                <span class="devlog-author">${
                                                devlog.author
                                                }</span>
                                                <div class="devlog-meta">
                                                    <span>${
                                                    devlog.timeSpent
                                                    } spent working</span>
                                                    <span> ‚Ä¢ </span>
                                                    <span>${devlog.timeAgo}</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="devlog-content">
                                            ${devlog.content}
                                        </div>
                                        ${
                                        devlog.attachment
                                            ? `<div class="devlog-attachment-container"><img alt="Devlog attachment" class="devlog-attachment" src="${devlog.attachment}" /></div>`
                                            : ''
                                        }
                                    </div>
                                `,
                                )
                                .join('')}
                            </div>
                        </div>
                    `;
                });

                mainAreaSection.innerHTML = `
                    <div class="page-content-wrapper">
                        <h1 class="page-title">Vote <span class="vote-needed-message">${data.voteCount.needed} needed!</span></h1>
                        <p class="page-subtitle">Vote on others' projects! ${data.voteCount.globalSubmitted} votes have been submitted so far!</p>

                        <div class="project-comparison-grid">
                            ${projectsHtml}
                        </div>

                        <div class="vote-form-container">
                            <form id="voteSubmissionForm" class="vote-form">
                                <input type="hidden" name="authenticity_token" value="${data.voteForm.authenticityToken}" />
                                <input type="hidden" name="vote[ship_event_1_id]" value="${data.voteForm.shipEvent1Id}" />
                                <input type="hidden" name="vote[ship_event_2_id]" value="${data.voteForm.shipEvent2Id}" />
                                <input type="hidden" name="vote[signature]" value="${data.voteForm.signature}" />
                                <input type="hidden" name="vote[project_1_demo_opened]" value="false" />
                                <input type="hidden" name="vote[project_1_repo_opened]" value="false" />
                                <input type="hidden" name="vote[project_2_demo_opened]" value="false" />
                                <input type="hidden" name="vote[project_2_repo_opened]" value="false" />
                                <input type="hidden" name="vote[time_spent_voting_ms]" value="0" />
                                <input type="hidden" name="vote[music_played]" value="false" />
                                <input type="hidden" name="commit" value="Submit Vote" />

                                <h2 class="vote-question">
                                    A good ship is technical, creative, and tells the story of how it was made.
                                    By that definition, which of these two projects is better?
                                </h2>

                                <div class="vote-options-group">
                                    <label class="vote-option-label">
                                        <input class="vote-option-input" required type="radio" value="${data.projects[0].id}" name="vote[winning_project_id]" id="project_choice_${data.projects[0].id}" />
                                        <div class="vote-option-button">${data.projects[0].title}</div>
                                    </label>

                                    <label class="vote-option-label">
                                        <input class="vote-option-input" required type="radio" value="tie" name="vote[winning_project_id]" id="project_choice_tie" />
                                        <div class="vote-option-button">Tie</div>
                                    </label>

                                    <label class="vote-option-label">
                                        <input class="vote-option-input" required type="radio" value="${data.projects[1].id}" name="vote[winning_project_id]" id="project_choice_${data.projects[1].id}" data-project-id="project2" />
                                        <div class="vote-option-button">${data.projects[1].title}</div>
                                    </label>
                                </div>

                                <div class="explanation-section">
                                    <textarea class="vote-explanation-textarea" rows="4" required placeholder="Tell us why you made this choice..." name="vote[explanation]" id="vote_explanation_text"></textarea>
                                </div>

                                <div class="submit-button-section">
                                    <button type="submit" class="submit-vote-button">Submit Vote</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;

                document
                    .getElementById('voteSubmissionForm')
                    .addEventListener('submit', handleVoteSubmission);
            }

            async function handleVoteSubmission(event) {
                event.preventDefault();
                const form = event.target;
                const formData = new FormData(form);

                const authenticityToken = formData.get('authenticity_token');
                const signature = formData.get('vote[signature]');
                const shipEvent1Id = formData.get('vote[ship_event_1_id]');
                const shipEvent2Id = formData.get('vote[ship_event_2_id]');
                const winningProjectId = formData.get('vote[winning_project_id]');
                const explanation = formData.get('vote[explanation]')?.trim();

                if (!winningProjectId) {
                    alert('Please select a project or tie.');
                    return;
                }
                if (!explanation) {
                    alert('Please provide an explanation.');
                    return;
                }

                const params = new URLSearchParams();
                // params.append('authenticity_token', authenticityToken);
                // params.append('vote[ship_event_1_id]', shipEvent1Id);
                // params.append('vote[ship_event_2_id]', shipEvent2Id);
                // params.append('vote[signature]', signature);
                // params.append('vote[winning_project_id]', winningProjectId);
                // params.append('vote[explanation]', explanation);
                // params.append('vote[project_1_demo_opened]', 'true');
                // params.append('vote[project_1_repo_opened]', 'true');
                // params.append('vote[project_2_demo_opened]', 'true');
                // params.append('vote[project_2_repo_opened]', 'true');
                // params.append('vote[time_spent_voting_ms]', '0');
                // params.append('vote[music_played]', 'false');
                // params.append('commit', 'Submit Vote');

                for (const [key, value] of params.entries()) {
                    console.log(`${key}: ${value}`);
                }

                const cookie = getToken();

                try {
                    const client = await getEpoxyClient();
                    const response = await client.fetch(
                        'https://cors-anywhere.herokuapp.com/https://summer.hackclub.com/votes/new',
                        {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
                                Cookie: cookie,
                                'User-Agent': navigator.userAgent,
                                'Referer': 'https://cors-anywhere.herokuapp.com/',
                                'Origin': 'https://cors-anywhere.herokuapp.com',
                                'X-Requested-With': 'XMLHttpRequest',
                                'X-CSRF-Token': authenticityToken,
                                Accept: 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8',
                            },
                            body: params.toString()
                        }
                    );

                    console.log('Response status:', response.status);
                    const text = await response.text();
                    console.log('Response body:', text);

                    if (response.ok) {
                        alert('Vote submitted successfully!');
                        loadPage();
                    } else {
                        console.error('Failed to submit vote:', response.status, text);

                        if (response.status === 422) {
                            alert("‚ùå Vote failed (422 Unprocessable Entity). Your session or token might be invalid. Refreshing projects...");
                            loadPage();
                        } else {
                            alert(`‚ùå Failed to submit vote: ${response.status}. Check console for details.`);
                        }
                        const submitButton = form.querySelector('input[type="submit"][name="commit"]');
                        if (submitButton) {
                            submitButton.disabled = false;
                            submitButton.value = 'Submit Vote';
                        }
                    }
                } catch (err) {
                    console.error('Network error:', err);
                    alert('Network error. Please try again.');
                }
            }

            // const happyDinoImages = [
            //     '/public/orpheus/party_dino.gif',
            //     '/public/orpheus/chill_dino.png',
            //     '/public/orpheus/party_orpheus.png',
            //     '/public/orpheus/nervous_dino.gif' // because i might've done my cache wrong who knows?
            // ];
            // const randomIndex = Math.floor(Math.random() * happyDinoImages.length);
            // document.getElementById('happy-dino').src = happyDinoImages[randomIndex];

            loadPage();
        </script>
    </body>
</html>